name: Notifications Worker Cron

on:
  schedule:
    - cron: '*/3 * * * *' # every 3 minutes (adjust as needed)
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Invoke notifications worker
        env:
          FUNCTION_URL: ${{ secrets.NOTIF_FUNCTION_URL }}
          CRON_SECRET: ${{ secrets.NOTIF_CRON_SECRET }}
        run: |
          if [ -z "${FUNCTION_URL}" ]; then
            echo "NOTIF_FUNCTION_URL secret missing" >&2
            exit 1
          fi
          if [ -z "${CRON_SECRET}" ]; then
            echo "NOTIF_CRON_SECRET secret missing" >&2
            exit 1
          fi
          echo "Calling notifications worker at ${FUNCTION_URL}"
          set -o pipefail
          http_code=$(curl -s -w '%{http_code}' -o response.json -H "x-cron-secret: ${CRON_SECRET}" "${FUNCTION_URL}")
          cat response.json
          echo "\nHTTP ${http_code}" 
          if [ "${http_code}" -ge 300 ]; then
            exit 1
          fi
